<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" th:href="@{/static/css/reset.css}" href="/static/css/reset.css"/>
    <link rel="stylesheet" type="text/css" th:href="@{/static/css/nowConfirmCard.css}"
          href="/static/css/nowConfirmCard.css"/>
    <link rel="stylesheet" th:href="@{/static/js/layui/css/layui.css}" type="text/css"/>
    <link rel="stylesheet"  th:href="@{/static/js/sweetalert/sweetalert.css}" type="text/css"/>
    <title>ç«‹å³ä¸‹å•</title>
    <style>
        .addressImg{
            background: url("/static/img/nowConfirmCard/btn-address.png") no-repeat;
        }
    </style>
</head>
<body>
<!-- é¡¶éƒ¨nav -->
<div th:replace="users/common/header::top_nav-fragment"></div>

<div class="outHeader">
    <div class="header container clearfix">
        <a href="index.html">
            <div class="logo fl ver_mid"></div>
        </a>
        <p class="confirmCard ver_mid fl">ç¡®è®¤è®¢å•</p>
        <div class="progressArea fr">
            <img src="/static/img/nowConfirmCard/progress_08.png">
        </div>

    </div>
</div>
<div class="address container clearfix ">
    <p class="address_title" >æ”¶è´§åœ°å€</p>
    <div th:unless="${#lists.isEmpty(addressList)}">
        <div class="address1 fl relative" id="addressRemove"
             th:each="address:${addressList}">
            <p class="address1_name clearfix">
            <span class="address1_name_name fl"
                  style="text-align: left; margin-left: 20px;">[[${address.userName}]]</span>
                <span class="address1_name_tel fr"
                      style="text-align: right; margin-right: 20px;">[[${address.phone}]]</span>
            </p>
            <p class="address1_msg">
                [[${address.address}]]
            </p>
            <span class="first_address absolute">
					[[${address.tag}]]
				</span>
            <span class="edit_address absolute">
					ğŸ’»ç¼–è¾‘
				</span>
            <span class="del_address absolute" th:addressId="${address.addressId}">
					ğŸ—‘åˆ é™¤
				</span>
        </div>
    </div>
    <div class="add_address fl">
        â• æ–°å¢æ”¶è´§åœ°å€
    </div>

</div>
<div class="goods container clearfix">
    <div class="goods_msg fl">
        <div class="goods_list clearfix" th:unless="${#lists.isEmpty(ShopCarPidList)}">
            <div th:each="ShopList:${ShopCarPidList}">
                <div class="mate20rs clearfix">
                    <img class="mate20rs_img fl" th:src="${ShopList.product.pimage}">
                    <ul class="fl clearfix">
                        <li class="mate20rs_msg fl">
                            <span id="pdesc">&nbsp;[[${ShopList.product.pdesc}]]</span>
                        </li>
                        <li class="mate20rs_num fl">
                            <span id="pidList" hidden>Ã—[[${ShopList.product.pid}]]</span>
                            <span id="shopCount">Ã—[[${ShopList.shopCount}]]</span>
                        </li>
                        <li class="mate20rs_price fl">
                            <span id="shopPrice">ï¿¥[[${ShopList.product.shopPrice}]]</span>
                        </li>
                    </ul>
                </div>
                <div class="mate20rs_extra">
                    <span class="extra_title fl">é…</span>
                    <ul class="fl clearfix">
                        <li class="extra_msg fl">
                            <img src="/static/img/nowConfirmCard/erji.png">
                            <span>HUAWEI FreeBuds 2 Proæ— çº¿è€³æœºï¼ˆç¢³æ™¶é»‘ï¼‰</span>
                        </li>
                        <li class="extra_num fl">
                            <span>Ã—1</span>
                        </li>
                        <li class="extra_price fl">
                            <span></span>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="mate20rs_more">
                <div class="mate20rs_invoice clearfix">
                    <div class="invoice1 fl">å‘ç¥¨ä¿¡æ¯</div>
                    <div class="invoice2 fl">å¦‚æœå•†å“ç”±ç¬¬ä¸‰æ–¹å–å®¶é”€å”®ï¼Œå‘ç¥¨å†…å®¹ç”±å…¶å–å®¶å†³å®šï¼Œå‘ç¥¨ç”±å–å®¶å¼€ç¥¨å¹¶å¯„å‡º</div>
                    <div class="invoice3 fl">ç”µå­æ™®é€šå‘ç¥¨ ä¸ªäºº<a href="">ä¿®æ”¹</a></div>
                </div>
                <div class="mate20rs_discounts clearfix">
                    <div class="discounts1 fl">ä¼˜æƒ ä¸æŠµç”¨</div>
                    <div class="discounts2">ä»…é€‚ç”¨äºè‡ªè¥å®ç‰©å•†å“</div>
                    <div class="discounts3"><img class="ver_mid" src="/static/img/nowConfirmCard/discount_02.png"><a
                            href="" class="ver_mid"
                            style="margin-left: 20px;">ä½¿ç”¨ä¼˜æƒ åˆ¸</a></div>
                    <div class="discounts4">
                        <input type="checkbox" style="width: 15px;height: 15px;" name="" id="" value=""/>
                        <span>å…±<span>0</span>ç§¯åˆ†ï¼Œä¸è¶³100ä¸å¯ä½¿ç”¨</span>
                        <a href="">ç§¯åˆ†è§„åˆ™</a>
                    </div>
                    <div class="discounts5">
                        <input type="checkbox" name="" id="" value=""/>
                        <span>èŠ±ç“£ä½™é¢<span>0</span>ï¼Œä¸è¶³100ä¸å¯ä½¿ç”¨</span>
                        <a href="">èŠ±ç“£ä½¿ç”¨è§„åˆ™</a>
                    </div>
                </div>

            </div>
        </div>

    </div>
    <div class="goods_settlement fr relative">
        <p class="settlement_title">å•†å“ç”±<span style="color: red;">Xmallå•†åŸ</span>é€‰æ‹©åˆä½œå¿«é€’</p>
        <div class="settlement">
            <div class="totalPrice clearfix">
                <span class="totalPrice_title">å•†å“æ€»é‡‘é¢:</span>
                <div class="totalPrice_price fr" id="price">ï¿¥12999</div>
            </div>
            <div class="totalPrice clearfix">
                <span class="totalPrice_title">è¿è´¹:</span>
                <div class="totalPrice_price fr">ï¿¥0.00</div>
            </div>
            <div class="totalPrice clearfix">
                <span class="totalPrice_title">ä¼˜æƒ é‡‘é¢:</span>
                <div class="totalPrice_price fr">-ï¿¥0.00</div>
            </div>
            <div class="totalPrice  clearfix">
                <span class="totalPrice_title">ç»“ç®—é‡‘é¢:</span>
                <div class="totalPrice_price fr" style="font-size: 22px; color: red;" id="price1">ï¿¥12999</div>
            </div>
        </div>
    </div>
</div>
<div class="submit clearfix container">

    <div class="submit_price">
        åº”ä»˜é‡‘é¢:
        <span style="font-size: 22px; color: red;" id="price2">ï¿¥12999.00</span>
    </div>
    <div class="available">
        å¯è·å¾—ç§¯åˆ†:1300
    </div>
    <div class="submit_address clearfix">
        <div class="address_none fr">
            æ— æ”¶è´§åœ°å€ï¼Œä¸å¯ä¸‹å•<a href="" style="margin-left: 10px;">ç‚¹å‡»å¡«å……</a>
        </div>
        <div class="confirm_address fr">
            é…é€è‡³:<span id="peisong"></span>
            <span id="shr"></span>
            <span id="dianhua"></span>
        </div>
    </div>
    <div class="submit_btn clearfix">
            <div class="fr" id="goSumbitOrder">
                æäº¤è®¢å•
            </div>
    </div>
</div>
<div class="footer">
    <div class="footer_top container clearfix">
        <div class="top_item fl">
            <a href="">
                <span class="ver_mid">ç™¾å¼ºä¼ä¸š å“è´¨ä¿è¯</span>
            </a>
        </div>
        <div class="top_item fl">
            <a href="">
                <span class="ver_mid">7å¤©é€€è´§ 15å¤©æ¢è´§</span>
            </a>
        </div>
        <div class="top_item fl">
            <a href="">
                <span class="ver_mid">48å…ƒèµ·å…è¿è´¹</span>
            </a>
        </div>
        <div class="top_item fl">
            <a href="">
                <span class="ver_mid">1000å®¶ç»´ä¿®ç½‘ç‚¹ å…¨å›½è”ä¿</span>
            </a>
        </div>
    </div>
    <div th:replace="users/common/footer::footer-fragment"></div>
</div>
<!-- æ·»åŠ åœ°å€ -->
<div class="bg_address1">
    <div class="address_box clearfix">
        <form class="clearfix" method="">
            <p class="address_box_title">--æ·»åŠ åœ°å€--</p>
            <label class="fl"><span>æ”¶è´§äººï¼š</span><input type="text" name="userName" id="userName"/></label>
            <label class="fl"><span>æ‰‹æœºå·ç ï¼š</span><input type="text" name="phone" id="phone"
                                                       placeholder="è¯·è¾“å…¥11ä½æ‰‹æœºå·ç "/></label>
            <label class="fl"><span>æ”¶è´§åœ°å€ï¼š</span><input type="text" name="address" id="address"
                                                       placeholder="è¯·è¾“å…¥çœ/å¸‚/åŒº/è¡—é“"/></label>
            <label>
                <span>é€‰æ‹©ï¼š</span>
                <select name="moren" id="moren" style="display: inline-block;width: 160px;height: 40px">
                    <option value="0" selected>é»˜è®¤</option>
                    <option value="1">å®¶</option>
                    <option value="2">å­¦æ ¡</option>
                    <option value="3">å…¬å¸</option>
                </select>
            </label>
            <label>
                <textarea name="note" id="note" class="info" rows="3" cols="30" placeholder="å¦‚é€‰æ‹©ä¸åˆ°æ‚¨çš„åœ°åŒº,è¯·åœ¨æ­¤å¤„è¯¦ç»†è¯´æ˜"></textarea>
                <small></small>
            </label>
        </form>
        <div class="address_box_return fl">
            å–æ¶ˆ
        </div>
        <div class="address_box_enter fl">
            ä¿å­˜å¹¶ä½¿ç”¨
        </div>
        <div class="address_box_del">
            X
        </div>
    </div>
</div>

<!--éšè—åŸŸè¡¨å•-->
<form action="/sumbitOrder" method="post" id="sumbitAllOrder">
    <input type="hidden" name="allProduct" id="allProduct">
    <input type="hidden" name="totalPrice" id="totalPrice">
    <input type="hidden" name="userName" id="goodsName">
    <input type="hidden" name="userPhone" id="goodsPhone">
    <input type="hidden" name="userAddress" id="goodsAddress">
    <input type="hidden" name="orderContent" id="orderContent">
</form>

<!-- ä¿®æ”¹åœ°å€ -->
<div class="bg_address2">
    <div class="address_box clearfix">
        <form class="clearfix" method="">
            <p class="address_box_title">--ä¿®æ”¹åœ°å€--</p>
            <label class="fl"><span>æ”¶è´§äººï¼š</span><input type="text" name="userName" class="address_name"
                                                      value=""/></label>
            <label class="fl"><span>æ‰‹æœºå·ç ï¼š</span><input type="text" name="phone" class="address_tel"
                                                       value=""/></label>
            <label class="fl"><span>æ”¶è´§åœ°å€ï¼š</span><input type="text" name="address" class="address_msg"
                                                       value=""/></label>
            <label>
                <span>é€‰æ‹©ï¼š</span>
                <select name="moren" class="address_moren" style="display: inline-block;width: 160px;height: 40px">
                    <option value="0" selected>é»˜è®¤</option>
                    <option value="1">å®¶</option>
                    <option value="2">å­¦æ ¡</option>
                    <option value="3">å…¬å¸</option>
                </select>
            </label>
        </form>
        <div class="address_box_return fl">
            å–æ¶ˆ
        </div>
        <div class="address_box_enter fl">
            ä¿å­˜å¹¶ä½¿ç”¨
        </div>
        <div class="address_box_del">
            X
        </div>
    </div>
</div>
<script src="/static/js/jquery-3.4.1.min.js" th:src="@{/static/js/jquery-3.4.1.min.js}" type="text/javascript"
        charset="utf-8"></script>
<script src="/static/js/layer/layer.js" th:src="@{/static/js/layer/layer.js}" type="text/javascript"
        charset="utf-8"></script>
<script th:src="@{/static/js/layui/layui.js}" type="text/javascript" charset="utf-8"></script>
<script th:src="@{/static/js/sweetalert/sweetalert.min.js}"></script>
<script type="text/javascript">

    //æäº¤è®¢å•
    $("#goSumbitOrder").click(function () {
        //åˆ¤æ–­æ˜¯å¦é€‰æ‹©äº†åœ°å€
        var address = $('#peisong').html();
        if(address==''||address==null){
            swal({
                icon: 'error',
                text: "è¯·é€‰æ‹©åœ°å€",

            })
            return;
        }
        //ç»™æ§åˆ¶å™¨ä¼ é€’ ä»·æ ¼ å•†å“pidï¼ˆlistï¼‰
        var totalPrice= $("#price").text();
        console.log(totalPrice);
        var pidList;
        var shopCountArry;
        var shopPriceArry;
        var productNameArry=[];
        $(".goods").each(function () {
            //è·å¾—æ‰€æœ‰é€‰ä¸­çš„shopCount æ•°ç»„
            shopCountArry = $(this).find(".goods_list").find(".mate20rs").find('#shopCount').text().slice(1).split('Ã—')
            console.log(shopCountArry);
            //è·å¾—æ‰€æœ‰é€‰ä¸­çš„pid æ•°ç»„
            pidList = $(this).find(".goods_list").find(".mate20rs").find('#pidList').text().slice(1).split('Ã—')
            console.log(pidList);
            //è·å¾—æ‰€æœ‰é€‰ä¸­çš„ä»·æ ¼æ•°ç»„
             shopPriceArry = $(this).find(".goods_list").find(".mate20rs").find('#shopPrice').text().slice(1).split('ï¿¥')
            //è·å¾—ç¬¬ä¸€ä¸ªæ‰‹æœºæè¿°  æ”¯ä»˜éœ€è¦
            //console.log($('#pdesc').text());
            // productNameArry.push()p
        });
        shopCar = pidList.map((pid, i) => ({pid, shopCount: shopCountArry[i],productPrice:shopPriceArry[i]}))
        console.log(pidList);
        console.log(shopCar);
        $('#allProduct').val(JSON.stringify(shopCar));
        $('#totalPrice').val(totalPrice)
        $('#goodsName').val($('#shr').text());
        $('#goodsPhone').val($('#dianhua').text());
        $('#goodsAddress').val($('#peisong').text().trim());
        //è·å¾—ç¬¬ä¸€ä¸ªæ‰‹æœºæè¿°  æ”¯ä»˜éœ€è¦
        $('#orderContent').val($('#pdesc').text().substring(1,40)+"......");
        //æäº¤è¡¨å•
        console.log(JSON.stringify(shopCar));
        //æäº¤è¡¨å•
        $("#sumbitAllOrder").submit();
       //window.location.href='/sumbitOrder?ids='+pidList+'&shopCountArry='+shopCountArry
    })


    $(".goods").each(function () {

        //è·å¾—æ‰€æœ‰é€‰ä¸­çš„shopCoun æ•°ç»„
        var shopCountArry = $(this).find(".goods_list").find(".mate20rs").find('#shopCount').text().slice(1).split('Ã—')
        console.log(shopCountArry);
        //è·å¾—æ‰€æœ‰ä»·æ ¼
        var shopPriceArry = $(this).find(".goods_list").find(".mate20rs").find('#shopPrice').text().slice(1).split('ï¿¥')
        console.log(shopPriceArry);
        var sumprice = 0;
        for (var i = 0; i < shopCountArry.length; i++) {
            for (var i = 0; i < shopPriceArry.length; i++) {
                //string è½¬ float æˆä¸ºnumberæ‰å¯ä»¥ç›¸ä¹˜
                var sum = parseFloat(shopPriceArry[i]) * parseFloat(shopCountArry[i])
                sumprice += sum;
            }
            //æ€»ä»·æ ¼
            console.log(sumprice);
        }
        //å›æ˜¾
        $("#price").html(sumprice)
        $("#price1").html(sumprice)
        $("#price2").html(sumprice)
    })


    $(".address").on("click", ".del_address", function () {
        //$(this).parent().css("display", "none")
         var addressId = $(this).attr('addressId');
         console.log(addressId);
         var flag = true;
         layer.confirm("ç¡®è®¤åˆ é™¤ï¼Ÿ", function (index) {
             if (flag) {
                 $.post('/deleteAddress', {addressId: addressId}, function (data) {
                     if (data.success) {
                        $('#addressRemove').remove();
                         layer.msg("å·²åˆ é™¤");
                     } else {
                         layer.msg("åˆ é™¤å¤±è´¥");
                     }
                     layer.close(index);
                 })
             }
         }, function () {
             //å–æ¶ˆ
             layer.msg("å–æ¶ˆæˆåŠŸ")
         });
    })

    $(".add_address").click(function () {
        console.log(1)
        $(".bg_address1").css("display", "block")
    })
    $(".address_box_return").click(function () {
        $(this).parent().parent().css("display", "none")
    })
    $(".address_box_del").click(function () {
        $(this).parent().parent().css("display", "none")
    })
    $(".bg_address1 .address_box_enter").click(function () {
        var userName = $('#userName').val();
        var phone = $('#phone').val();
        var address = $('#address').val();
        var note = $('#note').val();
        var moren = $('#moren').val();
        var order = {
            userName: userName,
            phone: phone,
            address: address,
            note: note,
            moren:moren
        };
        $.ajax({
            url: '/savaAddress',
            data: order,
            type: 'post',
            success: function (data) {
                   var $newAddress = $(
                       '<div class="address1 fl relative">' +
                       '<p class="address1_name clearfix">' +
                       '<span class="address1_name_name fl" style="text-align: left; margin-left: 20px;">' + data.userName + '</span>' +
                       '<span class="address1_name_tel fr" style="text-align: right; margin-right: 20px;">' + data.phone + '</span>' +
                       '</p><p class="address1_msg">' + data.address + '</p>' +
                       '<span class="edit_address absolute">ğŸ’»ç¼–è¾‘</span>' +
                       '<span class="del_address absolute">ğŸ—‘åˆ é™¤</span>' +
                       '</div>'
                   )
                   $($newAddress).insertBefore(".add_address")
            }
        })
        $(".bg_address1").css("display", "none")
    })
    $(".address").on("click", ".address1", function () {
        //æ·»åŠ å±æ€§cheakAddress  ä½œç”¨ï¼šåˆ¤æ–­æ˜¯å¦é€‰ä¸­
        console.log($(this).attr('cheakAddress','cheakAddress'));
        //æ·»åŠ æ ·å¼è¾¹æ¡† å›¾ç‰‡
        $(this).addClass("addressImg");
        //å…¶ä»–å­ç±»å»é™¤æ‰æ ·å¼
        $(this).siblings().removeClass(("addressImg"));
        //å…¶ä»–å­ç±»æ·»åŠ è¾¹æ¡†
        $(this).siblings().css("border-color", "lightgray");
        //é€‰ä¸­åå›æ˜¾åœ°å€åœ¨æœ€ä¸‹é¢
        if($(this).attr('cheakAddress')=='cheakAddress'){
            //é€‰æ‹©åœ°å€åæ‰ç»™æäº¤è®¢å•
           // $('.submit_btn').css("pointer-events","auto")
            $('.submit_btn').find('.fr').attr('id','sumbitOrder');
            let name = $(this).find('.address1_name_name').text();
            console.log(name);
            let phone = $(this).find('.address1_name_tel').text();
            console.log(phone);
            let address = $(this).find('.address1_msg').text();
            console.log(address);
            $('#shr').html(name)
            $('#dianhua').html(phone)
            $('#peisong').html(address)
        }
    })

    $(".address").on("click", ".edit_address", function () {
        $(".bg_address2").css("display", "block")
        var name = $(this).siblings(".address1_name").children(".address1_name_name").text()
        var tel = $(this).siblings(".address1_name").children(".address1_name_tel").text()
        var address = $(this).siblings(".address1_msg").text()
       // var moren = $(this).find('.first_address').text()
      //  console.log(moren);
        $(".bg_address2 .address_name").val(name)
        $(".bg_address2 .address_tel").val(tel)
        $(".bg_address2 .address_msg").val(address)
      //  $(".bg_address2 .address_moren").val(moren)
        var index = $(this).parents(".address1").index()
        // console.log(index)
        // è¾“å‡º
        $(".bg_address2 .address_box_enter").click(function () {
            if ($(".bg_address2 .address_box label input") == "") {
                alert("è¾“å…¥ä¸èƒ½ä¸ºç©º")
            } else {
                var newName = $(".bg_address2 .address_name").val()
                var newTel = $(".bg_address2 .address_tel").val()
                var newAddress = $(".bg_address2 .address_msg").val()
                $(".address").eq(index - 1).find(".address1_name_name").text(newName)
                $(".address").eq(index - 1).find(".address1_name_tel").text(newTel)
                $(".address").eq(index - 1).find(".address1_msg").text(newAddress)
            }
            $(".bg_address2").css("display", "none")
        })
    })


</script>
</body>
</html>
